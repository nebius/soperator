name: "Create GitHub release with automatic changelog"

on:
  workflow_dispatch:  # Manual trigger via GitHub UI

jobs:
  # First, build the stable release
  build:
    name: Build stable release
    uses: ./.github/workflows/one_job.yml
    with:
      unstable: 'false'
    secrets: inherit

  tag:
    name: Push new tag
    needs: build  # Wait for build to complete successfully

    permissions:
      contents: write

    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Get previous tag from current branch
        id: get-previous-tag
        run: |
          # Get the latest release tag (semantic version) that's reachable from the current commit
          # Match tags like: 1.2.3 (without 'v' prefix)
          # Exclude current version to support hotfix re-runs
          CURRENT_VERSION="$(cat VERSION)"
          PREV_TAG=$(git tag --merged HEAD^ | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | grep -v "^${CURRENT_VERSION}$" | sort -V | tail -1)
          if [ -z "$PREV_TAG" ]; then
            echo "Error: No previous release tag found in current branch history"
            echo "This is unexpected - there should be previous releases in the history"
            exit 1
          fi
          echo "tag=${PREV_TAG}" >> "${GITHUB_OUTPUT}"
          echo "Found previous tag: ${PREV_TAG}"

      - name: Get version
        id: get-version
        run: |
          VERSION="$(cat VERSION)"
          echo "version=${VERSION}" >> "${GITHUB_OUTPUT}"

      - name: Push new tag (force update if exists)
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          git tag -f "${VERSION}"
          git push -f origin "${VERSION}"

    outputs:
      previous-tag: ${{ steps.get-previous-tag.outputs.tag }}
      new-tag: ${{ steps.get-version.outputs.version }}

  release:
    name: Create release
    needs: tag

    permissions:
      pull-requests: read
      contents: write

    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@c9dc8369bccbc41e0ac887f8fd674f5925d315f7 # v5
        with:
          mode: "PR"
          fromTag: ${{ needs.tag.outputs.previous-tag }}
          toTag: ${{ needs.tag.outputs.new-tag }}
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\nContributors:\n#{{CONTRIBUTORS}}",
              "categories": [
                {
                    "key": "features",
                    "title": "## ğŸš€ Features",
                    "labels": ["feat", "feature"]
                },
                {
                    "key": "tests",
                    "title": "## ğŸ§ª Tests",
                    "labels": ["test"]
                },
                {
                    "key": "fixes",
                    "title": "## ğŸ› Fixes",
                    "labels": ["fix", "bug"]
                },
                {
                    "key": "dependencies",
                    "title": "## ğŸ“¦ Dependencies",
                    "labels": ["dependencies", "deps"]
                },
                {
                    "key": "docs",
                    "title": "## ğŸ“”Docs",
                    "labels": ["doc", "docs", "documentation"]
                },
                {
                    "key": "other",
                    "title": "## Other",
                    "labels": []
                }
              ],
              "ignore_labels": [
                  "ignore-for-release"
              ],
              "label_extractor": [
                {
                  "pattern": "^(other|docs|doc|dependencies|deps|feat|feature|fix|bug|test|.*)",
                  "target": "$1"
                }
              ]
            }
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release with changelog
        uses: softprops/action-gh-release@aec2ec56f94eb8180ceec724245f64ef008b89f5 # v2.4.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.tag.outputs.new-tag }}
          name: ${{ needs.tag.outputs.new-tag }}
          draft: false
          prerelease: false
          body: |
            Changes made since version `${{ steps.changelog.outputs.fromTag }}` prior to version `${{ steps.changelog.outputs.toTag }}`:

            ${{ steps.changelog.outputs.changelog }}

            | ğŸ“ **Categorized PRs** | ğŸ“‚ **Uncategorized PRs** | ğŸ“¥ **Commits** | â• **Lines added** | â– **Lines deleted** |
            | :---: | :---: | :---: | :---: | :---: |
            | ${{ steps.changelog.outputs.categorized_prs }} | ${{ steps.changelog.outputs.uncategorized_prs }} | ${{ steps.changelog.outputs.commits }} | ${{ steps.changelog.outputs.additions }} | ${{ steps.changelog.outputs.deletions }} |
