name: E2E Test Scheduler

on:
  schedule:
    # Periodically - uses persistent counter to rotate through main and release branches
    - cron: '0 */2 * * *'
  workflow_dispatch:  # Allow manual trigger for testing

permissions:
  contents: read
  actions: write

jobs:
  trigger-e2e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install yq
        uses: frenck/action-setup-yq@v1

      - name: Determine branch and terraform ref
        id: select_params
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          readarray -t RELEASE_BRANCHES < <(yq -r '.release_branches[]' .github/branch-config.yaml)
          BRANCHES=("main" "${RELEASE_BRANCHES[@]}")
          BRANCH_COUNT=${#BRANCHES[@]}

          COUNTER=$(gh variable get E2E_TRIGGER_COUNTER 2>/dev/null || echo "0")
          RUN_INDEX=$(( COUNTER % BRANCH_COUNT ))
          REF="${BRANCHES[$RUN_INDEX]}"
          TERRAFORM_REF="$REF"

          NEXT_COUNTER=$(( COUNTER + 1 ))
          gh variable set E2E_TRIGGER_COUNTER --body "$NEXT_COUNTER"

          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "terraform_ref=$TERRAFORM_REF" >> $GITHUB_OUTPUT
          echo "Testing branch $REF (counter=$COUNTER, index $RUN_INDEX of $BRANCH_COUNT branches)"

      - name: Trigger E2E test workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          REF="${{ steps.select_params.outputs.ref }}"
          TERRAFORM_REF="${{ steps.select_params.outputs.terraform_ref }}"

          echo "Triggering E2E test on branch: $REF"
          echo "With terraform ref: $TERRAFORM_REF"

          gh workflow run e2e_test.yml \
            --ref "$REF" \
            -f terraform_repo_ref="$TERRAFORM_REF"
          echo "E2E test workflow triggered successfully"
