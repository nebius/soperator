name: Build All in one job

on:
  workflow_call:
    inputs:
      unstable:
        description: "Build unstable version"
        type: string
        required: false
        default: "true"

  workflow_dispatch:
    inputs:
      unstable:
        description: "Build unstable version"
        type: string
        required: false
        default: "true"

  push:
    branches:
      - main
      - soperator-release-*
    tags:
      - "**" # Trigger on any tag

  # pull_request are defined separately to allow to run CI from forks.
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  packages: write
  attestations: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.filter.outputs.has_code_changes == 'true' || github.event_name != 'pull_request' }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          predicate-quantifier: 'every'
          filters: |
            has_code_changes:
              - '**'
              - '!docs/**'
              - '!CODEOWNERS'
              - '!LICENSE'
              - '!PROJECT'
              - '!README.md'
              - '!SECURITY.md'

  pre-build:
    needs: [changes]
    if: needs.changes.outputs.should_build == 'true'
    runs-on:
      - self-hosted
      - build

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0 # Fetch git history for the VERSION file changes detection

      - name: Install GO
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: "go.mod"
          cache: false

      - name: Generate version file
        run: |
          UNSTABLE="${{ inputs.unstable || 'true' }}"
          echo "Building with unstable=${UNSTABLE}"

          make get-version UNSTABLE=${UNSTABLE} >> version.txt
          echo "${UNSTABLE}" >> version.txt

      - name: Run make sync-version-from-scratch
        run: |
          make kustomize helmify yq
          make sync-version-from-scratch UNSTABLE=false

      - name: Check for uncommitted changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "âŒ Uncommitted changes detected after make sync-version-from-scratch"
            git status --porcelain
            git diff
            exit 1
          fi

      - name: Upload version file
        uses: actions/upload-artifact@v6
        with:
          name: version
          path: version.txt

      - name: Download version artifact
        uses: actions/download-artifact@v7
        with:
          name: version
          path: ./version

      - name: Read version and unstable
        id: read-version
        run: |
          VERSION=$(sed -n '1p' ./version/version.txt)
          UNSTABLE=$(sed -n '2p' ./version/version.txt)
          echo "Version: $VERSION"
          echo "Unstable: $UNSTABLE"

  lint:
    needs: [changes]
    if: needs.changes.outputs.should_build == 'true'
    runs-on:
      - self-hosted
      - build

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install GO
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: "go.mod"
          cache: false

      # These steps are not a matrix to avoid allocating 3 jobs on runners for something this small
      - name: golangci-lint on linux/amd64
        uses: golangci/golangci-lint-action@1481404843c368bc19ca9406f87d6e0fc97bdcfd # v7
        with:
          version: v2.5.0 # version of golangci-lint, should be in sync with Makefile.
        env:
          GOARCH: amd64
          GOOS: linux
      - name: golangci-lint on linux/arm64
        uses: golangci/golangci-lint-action@1481404843c368bc19ca9406f87d6e0fc97bdcfd # v7
        with:
          version: v2.5.0 # version of golangci-lint, should be in sync with Makefile.
        env:
          GOARCH: arm64
          GOOS: linux
      - name: golangci-lint on darwin/arm64
        uses: golangci/golangci-lint-action@1481404843c368bc19ca9406f87d6e0fc97bdcfd # v7
        with:
          version: v2.5.0 # version of golangci-lint, should be in sync with Makefile.
        env:
          GOARCH: arm64
          GOOS: darwin

  build-docker-images:
    needs: [changes, pre-build]
    if: needs.changes.outputs.should_build == 'true'
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        platform: [ linux/amd64, linux/arm64 ]
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch: amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install GO
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: "go.mod"
          cache: false

      - name: Download version artifact
        uses: actions/download-artifact@v7
        with:
          name: version
          path: ./version

      - name: Read version and unstable
        id: read-version
        run: |
          VERSION=$(sed -n '1p' ./version/version.txt)
          UNSTABLE=$(sed -n '2p' ./version/version.txt)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "unstable=$UNSTABLE" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"
          echo "Unstable: $UNSTABLE"

      - name: Log in to the Github Container registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Install Nebius CLI
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://storage.eu-north1.nebius.cloud/cli/install.sh | bash
          echo "$HOME/.nebius/bin" >> "$GITHUB_PATH"
          mkdir -p "$HOME/.nebius"
          echo "${{ secrets.NEBIUS_CONFIG_YAML_B64 }}" | base64 -d > "$HOME/.nebius/config.yaml"
          chmod 600 "$HOME/.nebius/config.yaml"

      - name: Configure Nebius docker credential-helper for auth
        shell: bash
        run: nebius registry configure-helper

      - name: Build and push Docker images
        shell: bash
        run: |
          UNSTABLE=${{ steps.read-version.outputs.unstable }}
          
          echo "Building for platform: ${{ matrix.platform }}"

          IMAGE_VERSION="$(make get-image-version UNSTABLE=${UNSTABLE})"
          VERSION=$(make get-version UNSTABLE=${UNSTABLE})
          OPERATOR_IMAGE_TAG=$(make get-operator-tag-version UNSTABLE=${UNSTABLE})
          NFS_VERSION=$(make get-nfs-version UNSTABLE=${UNSTABLE})

          make sync-version UNSTABLE=${UNSTABLE}

          echo "Updating CRDs & auto-generated code (included in test step) & run tests"
          make test-coverage UNSTABLE="${UNSTABLE}"
          
          echo "soperator controller - ${OPERATOR_IMAGE_TAG}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=slurm-operator DOCKERFILE=soperator-controllers/Dockerfile \
            IMAGE_VERSION="${OPERATOR_IMAGE_TAG}"
          
          echo "sconfigcontroller - ${OPERATOR_IMAGE_TAG}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=sconfigcontroller DOCKERFILE=soperator-controllers/Dockerfile \
            IMAGE_VERSION="${OPERATOR_IMAGE_TAG}"
          
          echo "rebooter - ${OPERATOR_IMAGE_TAG}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=rebooter DOCKERFILE=soperator-controllers/Dockerfile \
            IMAGE_VERSION="${OPERATOR_IMAGE_TAG}"
          
          echo "soperatorchecks - ${OPERATOR_IMAGE_TAG}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=soperatorchecks DOCKERFILE=soperator-controllers/Dockerfile \
            IMAGE_VERSION="${OPERATOR_IMAGE_TAG}"

          echo "soperator-exporter - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=soperator-exporter DOCKERFILE=soperator-controllers/Dockerfile \
            IMAGE_VERSION=${IMAGE_VERSION}

          echo "munge - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=munge DOCKERFILE=munge/munge.dockerfile IMAGE_VERSION=${IMAGE_VERSION}

          echo "controller_slurmctld - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=controller_slurmctld DOCKERFILE=controller/slurmctld.dockerfile \
            IMAGE_VERSION=${IMAGE_VERSION}

          echo "controller_slurmdbd - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=controller_slurmdbd DOCKERFILE=accounting/slurmdbd.dockerfile \
            IMAGE_VERSION=${IMAGE_VERSION}

          echo "slurmrestd - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=slurmrestd DOCKERFILE=restd/slurmrestd.dockerfile \
            IMAGE_VERSION=${IMAGE_VERSION}

          echo "slurm_check_job - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=slurm_check_job \
            DOCKERFILE=slurm_check_job/slurm_check_job.dockerfile IMAGE_VERSION=${IMAGE_VERSION}

          echo "k8s_check_job - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=k8s_check_job DOCKERFILE=k8s_check_job/k8s_check_job.dockerfile \
            IMAGE_VERSION=${IMAGE_VERSION}

          echo "sansible - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=sansible DOCKERFILE=sansible/sansible.dockerfile \
            IMAGE_VERSION=${IMAGE_VERSION}

          echo "login_sshd - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=login_sshd DOCKERFILE=login/sshd.dockerfile \
            IMAGE_VERSION=${IMAGE_VERSION}

          echo "worker_slurmd - ${IMAGE_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=worker_slurmd DOCKERFILE=worker/slurmd.dockerfile \
            IMAGE_VERSION=${IMAGE_VERSION}

          echo "nfs-server - ${NFS_VERSION}"
          make docker-build-and-push \
            PLATFORM="${{ matrix.platform }}" ARCH="${{ matrix.arch }}" DOCKER_BUILD_ARGS="${DOCKER_BUILD_ARGS}" \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=nfs-server DOCKERFILE=nfs-server/nfs.dockerfile \
            IMAGE_VERSION=${NFS_VERSION}


  build-jail-images:
    needs: [ changes, pre-build ]
    if: needs.changes.outputs.should_build == 'true'
    runs-on: ${{ matrix.runner }}

    strategy:
      fail-fast: false
      matrix:
        platform: [ linux/amd64, linux/arm64 ]
        cuda_version: [ "12.9.0", "13.0.2" ]
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            arch: amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install GO
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: "go.mod"
          cache: false

      - name: Download version artifact
        uses: actions/download-artifact@v7
        with:
          name: version
          path: ./version

      - name: Read version and unstable
        id: read-version
        run: |
          VERSION=$(sed -n '1p' ./version/version.txt)
          UNSTABLE=$(sed -n '2p' ./version/version.txt)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "unstable=$UNSTABLE" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"
          echo "Unstable: $UNSTABLE"

      - name: Log in to the Github Container registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Install Nebius CLI
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://storage.eu-north1.nebius.cloud/cli/install.sh | bash
          echo "$HOME/.nebius/bin" >> "$GITHUB_PATH"
          mkdir -p "$HOME/.nebius"
          echo "${{ secrets.NEBIUS_CONFIG_YAML_B64 }}" | base64 -d > "$HOME/.nebius/config.yaml"
          chmod 600 "$HOME/.nebius/config.yaml"

      - name: Configure Nebius docker credential-helper for auth
        shell: bash
        run: nebius registry configure-helper

      - name: Free Disk Space on runner
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Build and push populate_jail for ${{ matrix.arch }} CUDA ${{ matrix.cuda_version }}
        shell: bash
        run: |
          set -euo pipefail
          UNSTABLE='${{ steps.read-version.outputs.unstable }}'
          IMAGE_VERSION="$(make get-image-version UNSTABLE=${UNSTABLE})"

          CUDA_TAG="cuda${{ matrix.cuda_version }}"
          echo "Building and pushing populate_jail ${IMAGE_VERSION}-${CUDA_TAG} for ${{ matrix.platform }}"

          make docker-build-and-push \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=populate_jail DOCKERFILE=jail/jail.dockerfile \
            IMAGE_VERSION="${IMAGE_VERSION}-${CUDA_TAG}" ARCH="${{ matrix.arch }}" \
            PLATFORM="${{ matrix.platform }}" DOCKER_BUILD_ARGS="--build-arg CUDA_VERSION=${{ matrix.cuda_version }}"
          
          df -h

  manifest-docker-images:
    name: Create docker-images manifests
    needs: [build-docker-images]
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download version artifact
        uses: actions/download-artifact@v7
        with:
          name: version
          path: ./version

      - name: Read version and unstable
        id: read-version
        run: |
          VERSION=$(sed -n '1p' ./version/version.txt)
          UNSTABLE=$(sed -n '2p' ./version/version.txt)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "unstable=$UNSTABLE" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"
          echo "Unstable: $UNSTABLE"

      - name: Install Nebius CLI
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://storage.eu-north1.nebius.cloud/cli/install.sh | bash
          echo "$HOME/.nebius/bin" >> "$GITHUB_PATH"
          mkdir -p "$HOME/.nebius"
          echo "${{ secrets.NEBIUS_CONFIG_YAML_B64 }}" | base64 -d > "$HOME/.nebius/config.yaml"
          chmod 600 "$HOME/.nebius/config.yaml"

      - name: Configure Nebius docker credential-helper for auth
        shell: bash
        run: nebius registry configure-helper

      - name: Set up Docker Buildx (for imagetools)
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to the Github Container registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        shell: bash
        run: |
          set -euo pipefail
          UNSTABLE='${{ steps.read-version.outputs.unstable }}'
          IMAGE_VERSION="$(make get-image-version UNSTABLE=${UNSTABLE})"
          OPERATOR_IMAGE_TAG=$(make get-operator-tag-version UNSTABLE=${UNSTABLE})
          NFS_VERSION=$(make get-nfs-version UNSTABLE=${UNSTABLE})

          echo "Creating manifest for slurm-operator"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=slurm-operator IMAGE_VERSION="${OPERATOR_IMAGE_TAG}"
          
          echo "Creating manifest for sconfigcontroller"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=sconfigcontroller IMAGE_VERSION="${OPERATOR_IMAGE_TAG}"
          
          echo "Creating manifest for rebooter"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=rebooter IMAGE_VERSION="${OPERATOR_IMAGE_TAG}"
          
          echo "Creating manifest for soperatorchecks"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=soperatorchecks IMAGE_VERSION="${OPERATOR_IMAGE_TAG}"
          
          echo "Creating manifest for soperator-exporter"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=soperator-exporter IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for munge"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=munge IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for controller_slurmctld"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=controller_slurmctld IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for controller_slurmdbd"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=controller_slurmdbd IMAGE_VERSION="${IMAGE_VERSION}"

          echo "Creating manifest for slurmrestd"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=slurmrestd IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for slurm_check_job"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=slurm_check_job IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for k8s_check_job"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=k8s_check_job IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for sansible"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=sansible IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for login_sshd"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=login_sshd IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for worker_slurmd"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=worker_slurmd IMAGE_VERSION="${IMAGE_VERSION}"
          
          echo "Creating manifest for nfs-server"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=nfs-server IMAGE_VERSION="${NFS_VERSION}"

  manifest-populate-jail:
    name: Create populate_jail manifests
    needs: [build-jail-images]
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        cuda_version: ["12.9.0", "13.0.2"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download version artifact
        uses: actions/download-artifact@v7
        with:
          name: version
          path: ./version

      - name: Read version and unstable
        id: read-version
        run: |
          VERSION=$(sed -n '1p' ./version/version.txt)
          UNSTABLE=$(sed -n '2p' ./version/version.txt)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "unstable=$UNSTABLE" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"
          echo "Unstable: $UNSTABLE"

      - name: Install Nebius CLI
        shell: bash
        run: |
          set -euo pipefail
          curl -sSL https://storage.eu-north1.nebius.cloud/cli/install.sh | bash
          echo "$HOME/.nebius/bin" >> "$GITHUB_PATH"
          mkdir -p "$HOME/.nebius"
          echo "${{ secrets.NEBIUS_CONFIG_YAML_B64 }}" | base64 -d > "$HOME/.nebius/config.yaml"
          chmod 600 "$HOME/.nebius/config.yaml"

      - name: Configure Nebius docker credential-helper for auth
        shell: bash
        run: nebius registry configure-helper

      - name: Set up Docker Buildx (for imagetools)
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to the Github Container registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push manifest
        shell: bash
        run: |
          set -euo pipefail
          UNSTABLE='${{ steps.read-version.outputs.unstable }}'
          IMAGE_VERSION="$(make get-image-version UNSTABLE=${UNSTABLE})"
          CUDA_TAG="cuda${{ matrix.cuda_version }}"
  
          echo "Create manifest for populate_jail - ${IMAGE_VERSION}-${CUDA_TAG}"
          make docker-create-manifest \
            UNSTABLE="${UNSTABLE}" IMAGE_NAME=populate_jail IMAGE_VERSION="${IMAGE_VERSION}-${CUDA_TAG}"


  build-helm-charts:
    needs: [changes, pre-build]
    if: needs.changes.outputs.should_build == 'true'
    runs-on:
      - self-hosted
      - X64
      - build
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install GO
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: "go.mod"
          cache: false

      - name: Download version artifact
        uses: actions/download-artifact@v7
        with:
          name: version
          path: ./version

      - name: Read version and unstable
        id: read-version
        run: |
          VERSION=$(sed -n '1p' ./version/version.txt)
          UNSTABLE=$(sed -n '2p' ./version/version.txt)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "unstable=$UNSTABLE" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"
          echo "Unstable: $UNSTABLE"

      - name: Run Helm Tests
        run: make helmtest

      - name: Push Helm charts
        run: |
          UNSTABLE=${{ steps.read-version.outputs.unstable }}

          make sync-version UNSTABLE=${UNSTABLE}

          make release-helm UNSTABLE="${UNSTABLE}"

  helm-integration-test:
    name: Helm Chart Integration Test with Built Images
    needs:
      - changes
      - manifest-docker-images
      - manifest-populate-jail
      - build-helm-charts
    if: needs.changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Download version artifact
        uses: actions/download-artifact@v7
        with:
          name: version
          path: ./version

      - name: Read version and unstable
        id: read-version
        run: |
          VERSION=$(sed -n '1p' ./version/version.txt)
          UNSTABLE=$(sed -n '2p' ./version/version.txt)
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "unstable=$UNSTABLE" >> "$GITHUB_OUTPUT"
          echo "Version: $VERSION"
          echo "Unstable: $UNSTABLE"

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Install kind
        run: make install-kind

      - name: Install flux
        run: make install-flux

      - name: Install yq
        run: make yq

      - name: Run Helm Integration Tests
        run: |
          UNSTABLE=${{ steps.read-version.outputs.unstable }}
          make sync-version UNSTABLE=${UNSTABLE}
          go test -v -timeout 10m -tags=integration ./test/integration/
        env:
          GO111MODULE: on
          UNSTABLE: ${{ steps.read-version.outputs.unstable }}

      - name: Get cluster info
        if: always()
        shell: bash
        run: |
          mkdir -p ./cluster-info
          kubectl cluster-info dump --output-directory=./cluster-info || true
          echo "=== Pods ==="
          kubectl get pods -A -o wide || true
          echo "=== HelmReleases ==="
          kubectl get helmreleases -n flux-system || true
          echo "=== Flux Resources ==="
          ./bin/flux get all -n flux-system || true

      - name: Cleanup
        if: always()
        run: |
          make kind-delete || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: helm-integration-test-results
          path: |
            test/integration/*.log
            test/integration/*.xml
            cluster-info/
          retention-days: 1

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs:
      - changes
      - pre-build
      - lint
      - build-docker-images
      - manifest-populate-jail
      - build-helm-charts
      - helm-integration-test
    if: always()
    steps:
      - name: Check CI status
        shell: bash
        run: |
          # If build was skipped (PR with no code changes), that's OK
          if [[ "${{ needs.changes.outputs.should_build }}" != "true" ]]; then
            echo "No code changes in PR - CI skipped successfully"
            exit 0
          fi

          # Otherwise, check that all jobs passed
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "Some jobs failed"
            exit 1
          fi
          if [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "Some jobs were cancelled"
            exit 1
          fi
          echo "All CI jobs passed!"

  notify-failure:
    name: Notify Slack on failure
    needs: [ci-success]
    if: |
      always() &&
      github.event_name == 'workflow_dispatch' &&
      (needs.ci-success.result == 'failure' || needs.ci-success.result == 'cancelled')
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        shell: bash
        run: |
          STATUS="${{ needs.ci-success.result }}"
          if [[ "$STATUS" == "failure" ]]; then
            EMOJI=":x:"
            COLOR="danger"
          else
            EMOJI=":warning:"
            COLOR="warning"
          fi

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"${COLOR}\",
                \"title\": \"${EMOJI} Nightly Build ${STATUS}\",
                \"text\": \"Branch: ${{ github.ref_name }}\nWorkflow: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>\",
                \"footer\": \"soperator nightly build\"
              }]
            }"
