name: Nightly Multi-Arch Build

on:
  schedule:
    - cron: '0 0 * * *'  # Midnight UTC daily
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  actions: write

jobs:
  trigger-builds:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Trigger nightly builds on all branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # Always build main
          echo "Triggering nightly multi-arch build on main"
          gh workflow run one_job.yml --ref main -f multi_arch=true

          # Build all nightly release branches from config
          for branch in $(yq -r '.nightly_release_branches[]' .github/branch-config.yaml); do
            echo "Triggering nightly multi-arch build on ${branch}"
            gh workflow run one_job.yml --ref "${branch}" -f multi_arch=true
          done
          echo "All builds triggered"
