suite: test deployment scheduling fields (tolerations, affinity, nodeSelector)
release:
  name: test-soperator
  namespace: soperator-system
templates:
  - templates/deployment.yaml

tests:
  #
  # --- TOLERATIONS ---
  #
  - it: should not render tolerations when not set
    asserts:
      - isKind:
          of: Deployment
      - notExists:
          path: spec.template.spec.tolerations

  - it: should not render tolerations when empty array
    set:
      controllerManager:
        tolerations: []
    asserts:
      - isKind:
          of: Deployment
      - notExists:
          path: spec.template.spec.tolerations

  - it: should render tolerations with correct indentation when set
    set:
      controllerManager:
        tolerations:
          - key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.tolerations
          value:
            - key: "node-role.kubernetes.io/control-plane"
              operator: "Exists"
              effect: "NoSchedule"

  - it: should render multiple tolerations correctly
    set:
      controllerManager:
        tolerations:
          - key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"
          - key: "example.com/special"
            operator: "Equal"
            value: "true"
            effect: "NoExecute"
            tolerationSeconds: 3600
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.tolerations[0]
          value:
            key: "node-role.kubernetes.io/control-plane"
            operator: "Exists"
            effect: "NoSchedule"
      - equal:
          path: spec.template.spec.tolerations[1]
          value:
            key: "example.com/special"
            operator: "Equal"
            value: "true"
            effect: "NoExecute"
            tolerationSeconds: 3600

  - it: should render tolerations at the same level as other pod spec fields
    set:
      controllerManager:
        tolerations:
          - key: "test-key"
            operator: "Exists"
            effect: "NoSchedule"
    asserts:
      - exists:
          path: spec.template.spec.tolerations
      - exists:
          path: spec.template.spec.securityContext
      - exists:
          path: spec.template.spec.serviceAccountName
      - exists:
          path: spec.template.spec.terminationGracePeriodSeconds

  - it: should render deployment with correct metadata
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: test-soperator-manager
      - exists:
          path: metadata.labels["control-plane"]
      - equal:
          path: metadata.labels["control-plane"]
          value: controller-manager

  - it: should render deployment with correct replicas count
    set:
      controllerManager:
        replicas: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should handle tolerations with only operator Exists
    set:
      controllerManager:
        tolerations:
          - operator: "Exists"
    asserts:
      - equal:
          path: spec.template.spec.tolerations[0]
          value:
            operator: "Exists"

  - it: should handle tolerations with all possible effects
    set:
      controllerManager:
        tolerations:
          - key: "test1"
            effect: "NoSchedule"
          - key: "test2"
            effect: "PreferNoSchedule"
          - key: "test3"
            effect: "NoExecute"
    asserts:
      - lengthEqual:
          path: spec.template.spec.tolerations
          count: 3
      - equal:
          path: spec.template.spec.tolerations[0].effect
          value: "NoSchedule"
      - equal:
          path: spec.template.spec.tolerations[1].effect
          value: "PreferNoSchedule"
      - equal:
          path: spec.template.spec.tolerations[2].effect
          value: "NoExecute"

  #
  # --- AFFINITY ---
  #
  - it: should not render affinity when not set
    asserts:
      - isKind:
          of: Deployment
      - notExists:
          path: spec.template.spec.affinity

  - it: should not render affinity when empty map
    set:
      controllerManager:
        affinity: {}
    asserts:
      - isKind:
          of: Deployment
      - notExists:
          path: spec.template.spec.affinity

  - it: should render nodeAffinity correctly when set
    set:
      controllerManager:
        affinity:
          nodeAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              nodeSelectorTerms:
                - matchExpressions:
                    - key: "kubernetes.io/os"
                      operator: "In"
                      values: ["linux"]
    asserts:
      - isKind:
          of: Deployment
      - exists:
          path: spec.template.spec.affinity
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0]
          value:
            key: "kubernetes.io/os"
            operator: "In"
            values:
              - "linux"

  - it: should render podAntiAffinity preferred rules correctly
    set:
      controllerManager:
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  topologyKey: "kubernetes.io/hostname"
                  labelSelector:
                    matchLabels:
                      app.kubernetes.io/name: "soperator"
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].weight
          value: 100
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].podAffinityTerm.topologyKey
          value: "kubernetes.io/hostname"
      - equal:
          path: spec.template.spec.affinity.podAntiAffinity.preferredDuringSchedulingIgnoredDuringExecution[0].podAffinityTerm.labelSelector.matchLabels["app.kubernetes.io/name"]
          value: "soperator"

  - it: should render affinity at the same level as other pod spec fields
    set:
      controllerManager:
        affinity:
          nodeAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 1
                preference:
                  matchExpressions:
                    - key: "example.com/test"
                      operator: "Exists"
    asserts:
      - exists:
          path: spec.template.spec.affinity
      - exists:
          path: spec.template.spec.securityContext
      - exists:
          path: spec.template.spec.serviceAccountName
      - exists:
          path: spec.template.spec.terminationGracePeriodSeconds

  #
  # --- NODESELECTOR ---
  #
  - it: should not render nodeSelector when not set
    asserts:
      - isKind:
          of: Deployment
      - notExists:
          path: spec.template.spec.nodeSelector

  - it: should not render nodeSelector when empty map
    set:
      controllerManager:
        nodeSelector: {}
    asserts:
      - isKind:
          of: Deployment
      - notExists:
          path: spec.template.spec.nodeSelector

  - it: should render nodeSelector correctly when set
    set:
      controllerManager:
        nodeSelector:
          kubernetes.io/os: linux
          node-role.kubernetes.io/control-plane: ""
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.nodeSelector
          value:
            kubernetes.io/os: linux
            node-role.kubernetes.io/control-plane: ""

  - it: should render nodeSelector at the same level as other pod spec fields
    set:
      controllerManager:
        nodeSelector:
          kubernetes.io/os: linux
    asserts:
      - exists:
          path: spec.template.spec.nodeSelector
      - exists:
          path: spec.template.spec.securityContext
      - exists:
          path: spec.template.spec.serviceAccountName
      - exists:
          path: spec.template.spec.terminationGracePeriodSeconds
