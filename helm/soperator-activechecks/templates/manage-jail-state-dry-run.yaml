apiVersion: slurm.nebius.ai/v1alpha1
kind: ActiveCheck
metadata:
  name: "manage-jail-state-dry-run"
spec:
  checkType: "k8sJob"
  name: "manage-jail-state-dry-run"
  dependsOn: [ "create-user-soperatorchecks" ]
  slurmClusterRefName: {{ .Values.slurmClusterRefName | quote }}
  schedule: {{ .Values.checks.manageJailStateDryRun.schedule | quote }}
  suspend: {{ .Values.checks.manageJailStateDryRun.suspend }}
  runAfterCreation: {{ .Values.checks.manageJailStateDryRun.runAfterCreation }}
  k8sJobSpec:
    jobContainer:
      command: [ "/opt/bin/k8s_check_job_entrypoint.sh" ]
      args:
        - ansible-playbook
        - -i
        - inventory/
        - -c
        - local
        - -e
        - ansible_connection=community.general.chroot
        - -e
        - ansible_host=/mnt/jail
        - -e
        - ansible_python_interpreter=/usr/bin/python3
        - run.yml
        - -t
        - run-all-upgrade
        - --diff
        - --check
      image: {{ .Values.images.k8sJob | quote }}
      env:
{{ toYaml .Values.checks.manageJailStateDryRun.env | indent 8 }}
      volumeMounts:
{{ toYaml .Values.jobContainer.volumeMounts | indent 8 }}
      volumes:
{{ toYaml .Values.jobContainer.volumes | indent 8 }}
