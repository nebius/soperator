suite: reactions conflict
templates:
  - templates/ib-gpu-perf.yaml
  - templates/active-checks.yaml

tests:
  - it: should fail if both commentSlurmNode and drainSlurmNode are set under failureReactions
    template: templates/ib-gpu-perf.yaml
    set:
      checks:
        ib-gpu-perf:
          failureReactions:
            commentSlurmNode:
              commentPrefix: "[node_problem]"
            drainSlurmNode:
              drainReasonPrefix: "[node_problem]"
    asserts:
      - failedTemplate:
          errorMessage: "checks.ib-gpu-perf.failureReactions: cannot set both commentSlurmNode and drainSlurmNode simultaneously"

  - it: should render when only commentSlurmNode is set
    template: templates/ib-gpu-perf.yaml
    set:
      checks:
        ib-gpu-perf:
          failureReactions:
            commentSlurmNode:
              commentPrefix: "[node_problem]"
    asserts:
      - notFailedTemplate: {}

  - it: should render when only drainSlurmNode is set
    template: templates/ib-gpu-perf.yaml
    set:
      checks:
        ib-gpu-perf:
          failureReactions:
            drainSlurmNode:
              drainReasonPrefix: "[node_problem]"
            # ib-gpu-perf.yaml hardcodes commentSlurmNode.commentPrefix in output,
            # so we can't set commentSlurmNode: null - use empty string instead.
            commentSlurmNode:
              commentPrefix: ""
    asserts:
      - notFailedTemplate: {}

  - it: gpu-fryer should fail if both commentSlurmNode and drainSlurmNode are set under failureReactions
    template: templates/active-checks.yaml
    set:
      checks:
        gpu-fryer:
          failureReactions:
            commentSlurmNode:
              commentPrefix: "[node_problem]"
            drainSlurmNode:
              drainReasonPrefix: "[node_problem]"
    asserts:
      - failedTemplate:
          errorMessage: "checks.gpu-fryer.failureReactions: cannot set both commentSlurmNode and drainSlurmNode simultaneously"

  - it: gpu-fryer should render when only commentSlurmNode is set
    template: templates/active-checks.yaml
    set:
      checks:
        gpu-fryer:
          failureReactions:
            commentSlurmNode:
              commentPrefix: "[node_problem]"
            drainSlurmNode: null
    asserts:
      - notFailedTemplate: {}

  - it: gpu-fryer should render when only drainSlurmNode is set
    template: templates/active-checks.yaml
    set:
      checks:
        gpu-fryer:
          failureReactions:
            commentSlurmNode: null
            drainSlurmNode:
              drainReasonPrefix: "[node_problem]"
    asserts:
      - notFailedTemplate: {}

  - it: gpu-fryer should render when both reaction nodes are explicitly null
    template: templates/active-checks.yaml
    set:
      checks:
        gpu-fryer:
          failureReactions:
            commentSlurmNode: null
            drainSlurmNode: null
    asserts:
      - notFailedTemplate: {}
