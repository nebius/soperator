suite: reactions conflict
templates:
  - templates/ib-gpu-perf.yaml
  - templates/active-checks.yaml

tests:
  - it: should fail if both commentSlurmNode and drainSlurmNode are set under failureReactions
    set:
      checks:
        ibGpuPerf:
          failureReactions:
            commentSlurmNode:
              commentPrefix: "[node_problem]"
            drainSlurmNode:
              drainReasonPrefix: "[node_problem]"
    asserts:
      - failedTemplate:
          errorMessage: "checks.ibGpuPerf.failureReactions: cannot set both commentSlurmNode and drainSlurmNode simultaneously"

  - it: should render when only commentSlurmNode is set
    set:
      checks:
        ibGpuPerf:
          failureReactions:
            commentSlurmNode:
              commentPrefix: "[node_problem]"
    asserts:
      - notFailedTemplate: {}

  - it: should render when only drainSlurmNode is set
    set:
      checks:
        ibGpuPerf:
          failureReactions:
            drainSlurmNode:
              drainReasonPrefix: "[node_problem]"
    asserts:
      - notFailedTemplate: {}

  - it: should render when both reaction nodes are explicitly null
    set:
      checks:
        ibGpuPerf:
          failureReactions:
            commentSlurmNode: null
            drainSlurmNode: null
    asserts:
      - notFailedTemplate: {}

  - it: gpu-fryer should fail if both commentSlurmNode and drainSlurmNode are set under failureReactions
    set:
      checks:
        "gpu-fryer":
          failureReactions:
            commentSlurmNode:
              commentPrefix: "[node_problem]"
            drainSlurmNode:
              drainReasonPrefix: "[node_problem]"
    asserts:
      - failedTemplate:
          errorMessage: "checks.gpu-fryer.failureReactions: cannot set both commentSlurmNode and drainSlurmNode simultaneously"

  - it: gpu-fryer should render when only commentSlurmNode is set
    set:
      checks:
        "gpu-fryer":
          failureReactions:
            commentSlurmNode:
              commentPrefix: "[node_problem]"
    asserts:
      - notFailedTemplate: {}

  - it: gpu-fryer should render when only drainSlurmNode is set
    set:
      checks:
        "gpu-fryer":
          failureReactions:
            drainSlurmNode:
              drainReasonPrefix: "[node_problem]"
    asserts:
      - notFailedTemplate: {}

  - it: gpu-fryer should render when both reaction nodes are explicitly null
    set:
      checks:
        "gpu-fryer":
          failureReactions:
            commentSlurmNode: null
            drainSlurmNode: null
    asserts:
      - notFailedTemplate: {}