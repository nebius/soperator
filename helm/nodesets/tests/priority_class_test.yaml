suite: test nodesets priority classes
templates:
  - templates/priority-class.yaml
tests:
  - it: should render single priority class
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: PriorityClass

  - it: should configure soperator-worker-high-priority class correctly
    documentIndex: 0
    asserts:
      - equal:
          path: metadata.name
          value: "soperator-worker-high-priority"
      - equal:
          path: value
          value: 1e+07
      - equal:
          path: globalDefault
          value: false
      - equal:
          path: description
          value: "High priority class for Slurm workers"
      - equal:
          path: preemptionPolicy
          value: "PreemptLowerPriority"

  - it: should include common labels
    asserts:
      - exists:
          path: metadata.labels["helm.sh/chart"]
      - exists:
          path: metadata.labels["app.kubernetes.io/name"]
      - exists:
          path: metadata.labels["app.kubernetes.io/instance"]
      - exists:
          path: metadata.labels["app.kubernetes.io/managed-by"]

  - it: should work with custom priority classes
    set:
      priorityClasses:
        - name: &customPriority "custom-priority"
          value: &customValue 500000
          globalDefault: &customGlobalDefault true
          description: &customDescription "Custom priority class"
          annotations:
            custom.annotation: &customAnnLabelValue "test"
          labels:
            custom.label: *customAnnLabelValue
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: *customPriority
      - equal:
          path: value
          value: *customValue
      - equal:
          path: globalDefault
          value: *customGlobalDefault
      - equal:
          path: metadata.annotations["custom.annotation"]
          value: *customAnnLabelValue
      - equal:
          path: metadata.labels["custom.label"]
          value: *customAnnLabelValue
      - equal:
          path: description
          value: *customDescription

  - it: should work with empty priority classes
    set:
      priorityClasses: []
    asserts:
      - hasDocuments:
          count: 0

  - it: should fail if priority class name is not set
    set:
      priorityClasses:
        - name: ""
    asserts:
      - failedTemplate:
          errorMessage: ".Values.priorityClasses[*].name is required."

  - it: should work with just name set
    set:
      priorityClasses:
        - name: &minimalPC "minimal-priority-class"
    documentIndex: 0
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: *minimalPC
      - notExists:
          path: metadata.annotations
      - exists:
          path: metadata.labels["helm.sh/chart"]
      - exists:
          path: metadata.labels["app.kubernetes.io/name"]
      - exists:
          path: metadata.labels["app.kubernetes.io/instance"]
      - exists:
          path: metadata.labels["app.kubernetes.io/managed-by"]
      - isNullOrEmpty:
          path: description
      - equal:
          path: value
          value: 10000000
      - equal:
          path: globalDefault
          value: false
      - notExists:
          path: preemptionPolicy
