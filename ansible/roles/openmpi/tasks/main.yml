---

- name: Collect host facts
  ansible.builtin.setup:
  tags:
    - openmpi

- name: Show system info
  ansible.builtin.debug:
    msg:
      - "Architecture: {{ ansible_architecture }}"
      - "Distro version: ubuntu{{ ansible_distribution_version }}"
  tags:
    - openmpi

- name: Configure ofed repositories
  ansible.builtin.template:
    src: mellanox_mlnx_ofed.list.j2
    dest: /etc/apt/sources.list.d/mellanox_mlnx_ofed.list
    mode: "0644"
  tags:
    - openmpi

- name: Add mellanox gpg key
  ansible.builtin.apt_key:
    url: https://www.mellanox.com/downloads/ofed/RPM-GPG-KEY-Mellanox
    keyring: /etc/apt/trusted.gpg
  tags:
    - openmpi

- name: Ensure openmpi packages are installed
  ansible.builtin.apt:
    name:
      - openmpi={{ openmpi.version }}
      - ucx={{ openmpi.ucx_version }}
    state: present
    update_cache: true
  tags:
    - openmpi

- name: Add OpenMPI to global PATH
  ansible.builtin.copy:
    dest: /etc/profile.d/path_openmpi.sh
    content: |
      export PATH=$PATH:/usr/mpi/gcc/openmpi-{{ openmpi.version_short }}/bin
    owner: root
    group: root
    mode: '0644'
  tags:
    - openmpi

- name: Configure OpenMPI library paths
  ansible.builtin.copy:
    dest: /etc/ld.so.conf.d/openmpi.conf
    content: |
      /lib/{{ ansible_architecture }}-linux-gnu
      /usr/lib/{{ ansible_architecture }}-linux-gnu
      /usr/local/cuda/targets/{{ ansible_architecture }}-linux/lib
      /usr/mpi/gcc/openmpi-{{ openmpi.version_short }}/lib
    owner: root
    group: root
    mode: '0644'
  register: openmpi_conf
  notify:
    - Update linker cache
  tags:
    - openmpi
